import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import WhatIfPage from '../WhatIfPage';

// Mock DataContext
const defaultContextValue: {
  filteredData: Record<string, unknown>[];
  rawData: Record<string, unknown>[];
  outcome: string;
  specs: { usl?: number; lsl?: number; target?: number };
  filters: Record<string, (string | number)[]>;
} = {
  filteredData: [
    { Machine: 'A', Value: 10 },
    { Machine: 'A', Value: 11 },
    { Machine: 'B', Value: 20 },
    { Machine: 'B', Value: 19 },
  ],
  rawData: [
    { Machine: 'A', Value: 10 },
    { Machine: 'A', Value: 11 },
    { Machine: 'B', Value: 20 },
    { Machine: 'B', Value: 19 },
  ],
  outcome: 'Value',
  specs: { usl: 25, lsl: 5 },
  filters: {},
};

let contextValue = { ...defaultContextValue };

vi.mock('../../context/DataContext', () => ({
  useData: () => contextValue,
}));

// Mock calculateStats
vi.mock('@variscout/core', () => ({
  calculateStats: vi.fn(() => ({
    mean: 15,
    stdDev: 5,
    cpk: 0.67,
    n: 4,
  })),
}));

// Mock WhatIfSimulator (now imported by WhatIfPageBase from @variscout/ui)
vi.mock('@variscout/ui', async () => {
  const actual = await vi.importActual<typeof import('@variscout/ui')>('@variscout/ui');
  return {
    ...actual,
    WhatIfPageBase: ({
      filteredData,
      rawData,
      outcome,
      specs,
      filterCount,
      onBack,
      colorScheme,
    }: any) => {
      // Simplified rendering that mirrors the real WhatIfPageBase behavior
      if (!outcome || rawData.length === 0) {
        return (
          <div>
            <button onClick={onBack}>Back</button>
            <p>Load data and set specification limits first.</p>
          </div>
        );
      }
      const hasSpecs = specs.usl !== undefined || specs.lsl !== undefined;
      return (
        <div>
          <button onClick={onBack} title="Back to Dashboard">
            Back
          </button>
          <h1>What-If Simulator</h1>
          <span>{outcome}</span>
          <span>n = {filteredData.length}</span>
          {filterCount > 0 && (
            <span>
              {filterCount} filter{filterCount !== 1 ? 's' : ''}
            </span>
          )}
          {!hasSpecs && <p>Set specification limits (USL/LSL) to see Cpk and yield projections.</p>}
          <div data-testid="simulator">WhatIfSimulator</div>
        </div>
      );
    },
  };
});

describe('WhatIfPage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    contextValue = { ...defaultContextValue };
  });

  it('shows empty state when no outcome set', () => {
    contextValue = { ...defaultContextValue, outcome: '' };
    render(<WhatIfPage onBack={() => {}} />);
    expect(screen.getByText('Load data and set specification limits first.')).toBeInTheDocument();
  });

  it('shows empty state when rawData is empty', () => {
    contextValue = { ...defaultContextValue, rawData: [], filteredData: [] };
    render(<WhatIfPage onBack={() => {}} />);
    expect(screen.getByText('Load data and set specification limits first.')).toBeInTheDocument();
  });

  it('shows back button that calls onBack', () => {
    const onBack = vi.fn();
    render(<WhatIfPage onBack={onBack} />);

    const backButton = screen.getByTitle('Back to Dashboard');
    fireEvent.click(backButton);
    expect(onBack).toHaveBeenCalledOnce();
  });

  it('shows specs warning when no USL/LSL set', () => {
    contextValue = {
      ...defaultContextValue,
      specs: {},
    };
    render(<WhatIfPage onBack={() => {}} />);
    expect(
      screen.getByText('Set specification limits (USL/LSL) to see Cpk and yield projections.')
    ).toBeInTheDocument();
  });

  it('does not show specs warning when specs are set', () => {
    render(<WhatIfPage onBack={() => {}} />);
    expect(
      screen.queryByText('Set specification limits (USL/LSL) to see Cpk and yield projections.')
    ).not.toBeInTheDocument();
  });

  it('renders WhatIfSimulator when data and stats available', () => {
    render(<WhatIfPage onBack={() => {}} />);
    expect(screen.getByTestId('simulator')).toBeInTheDocument();
  });

  it('shows outcome name and sample count in header', () => {
    render(<WhatIfPage onBack={() => {}} />);
    expect(screen.getByText('Value')).toBeInTheDocument();
    expect(screen.getByText('n = 4')).toBeInTheDocument();
  });

  it('shows filter count when filters active', () => {
    contextValue = {
      ...defaultContextValue,
      filters: { Machine: ['A'] },
    };
    render(<WhatIfPage onBack={() => {}} />);
    expect(screen.getByText('1 filter')).toBeInTheDocument();
  });

  it('shows plural filters label for multiple filters', () => {
    contextValue = {
      ...defaultContextValue,
      filters: { Machine: ['A'], Shift: ['Morning'] },
    };
    render(<WhatIfPage onBack={() => {}} />);
    expect(screen.getByText('2 filters')).toBeInTheDocument();
  });

  it('shows What-If Simulator heading', () => {
    render(<WhatIfPage onBack={() => {}} />);
    const headings = screen.getAllByText('What-If Simulator');
    expect(headings.length).toBeGreaterThan(0);
  });

  it('back button works in empty state too', () => {
    contextValue = { ...defaultContextValue, outcome: '' };
    const onBack = vi.fn();
    render(<WhatIfPage onBack={onBack} />);

    const buttons = screen.getAllByRole('button');
    fireEvent.click(buttons[0]);
    expect(onBack).toHaveBeenCalledOnce();
  });
});
